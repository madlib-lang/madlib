name: 'Build windows target for release'

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release ( ex: v0.0.1 )'
        required: true

env:
  node-version: 14.x

jobs:
  release:
    runs-on: windows-2019
    steps:
      - name: Checkout madlib
        uses: actions/checkout@v2

      - name: Install Haskell tools
        run: |
          choco install ghc --version 8.10.7 -m -r
          choco install haskell-stack --version 2.7.3 -m -r
          choco install cabal --version 3.4.0.0 -m -r

      - name: Configure stack
        run: stack config set system-ghc --global true

      - name: Use Node.js ${{ env.node-version }}
        uses: actions/setup-node@v1
        with:
          node-version: ${{ env.node-version }}

      - name: Install rollup
        run: npm i -g rollup @rollup/plugin-node-resolve

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          update: true
          install: >-
            git
            mingw-w64-x86_64-curl
            unzip
            tar

      - name: Install LLVM 9
        run: |
          curl https://github.com/madlib-lang/llvm-build-actions/releases/download/v0.0.1/llvm9-mingw64.zip --output LLVM.zip
          unzip LLVM
          rm -rf "/c/Program Files/LLVM"
          mv LLVM "/c/Program Files/"
        shell: msys2 {0}

      - name: Update paths
        run: |
          echo "PATH=c:\Program Files\LLVM\bin;D:\a\_temp\msys64\mingw64\bin;$env:PATH" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Install happy and alex
        run: stack install alex happy

      - run: |
          stack build -v --flag madlib:static
          stack run -- --help

      - name: Build tools
        run: |
          export PATH="$(npm get prefix)/bin:$PATH"
          ./scripts/build
        shell: msys2 {0}
        env:
          MSYS2_PATH_TYPE: inherit

      - name: Copy executable
        run: cp "$(stack path --dist-dir)/build/madlib/madlib.exe" ./
        shell: msys2 {0}
        env:
          MSYS2_PATH_TYPE: inherit

      - name: Upload executable
        uses: actions/upload-artifact@v2
        with:
          name: madlib.exe
          path: madlib.exe

